!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@fr0st/query"),require("@fr0st/ui")):"function"==typeof define&&define.amd?define(["exports","@fr0st/query","@fr0st/ui"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).UI=t.UI||{},t.fQuery,t.UI)}(this,(function(t,e,s){"use strict";class i extends s.BaseComponent{constructor(t,s){if(super(t,s),!e.is(this._node,"select"))throw new Error("TagsInput must be created on a select element");let i;this._placeholderText=this._options.placeholder,this._maxSelections=this._options.maxSelections,this._data=[],this._optionLookup={},this._activeItems=[],this._getData=null,e._isFunction(this._options.getResults)?this._getResultsInit():i=e._isArray(this._options.data)?this._options.data:this._getDataFromDOM(this._node),i&&(this._data=i,this._getDataInit());const n=[...this._node.selectedOptions].map((t=>e.getValue(t)));this._render(),this._setValue(n),this._events()}disable(){e.setAttribute(this._node,{disabled:!0}),this._refreshDisabled()}dispose(){this._popper&&(this._popper.dispose(),this._popper=null),e.removeAttribute(this._node,"tabindex"),e.removeEvent(this._node,"focus.ui.tagsinput"),e.removeClass(this._node,this.constructor.classes.hide),e.remove(this._menuNode),e.remove(this._toggle),this._toggle=null,this._clear=null,this._searchInput=null,this._placeholder=null,this._menuNode=null,this._data=null,this._optionLookup=null,this._activeItems=null,this._value=null,this._request=null,this._popperOptions=null,this._getData=null,super.dispose()}enable(){e.removeAttribute(this._node,"disabled"),this._refreshDisabled()}hide(){e.isConnected(this._menuNode)&&!e.getDataset(this._menuNode,"uiAnimating")&&e.triggerOne(this._node,"hide.ui.tagsinput")&&(e.setDataset(this._menuNode,{uiAnimating:"out"}),this._refreshPlaceholder(),e.fadeOut(this._menuNode,{duration:this._options.duration}).then((t=>{this._popper.dispose(),this._popper=null,e.empty(this._menuNode),e.detach(this._menuNode),e.removeDataset(this._menuNode,"uiAnimating"),e.setAttribute(this._toggle,{"aria-expanded":!1,"aria-activedescendent":""}),e.triggerEvent(this._node,"hidden.ui.tagsinput")})).catch((t=>{"out"===e.getDataset(this._menuNode,"uiAnimating")&&e.removeDataset(this._menuNode,"uiAnimating")})))}show(){if(!this._getData||e.is(this._node,":disabled")||e.isConnected(this._menuNode)||e.getDataset(this._menuNode,"uiAnimating")||!e.triggerOne(this._node,"show.ui.tagsinput"))return;const t=e.getValue(this._searchInput);this._getData({term:t}),e.setDataset(this._menuNode,{uiAnimating:"in"}),this._options.appendTo?e.append(this._options.appendTo,this._menuNode):e.after(this._toggle,this._menuNode),this._popper=new s.Popper(this._menuNode,this._popperOptions),e.fadeIn(this._menuNode,{duration:this._options.duration}).then((t=>{e.removeDataset(this._menuNode,"uiAnimating"),e.setAttribute(this._toggle,{"aria-expanded":!0}),e.triggerEvent(this._node,"shown.ui.tagsinput")})).catch((t=>{"in"===e.getDataset(this._menuNode,"uiAnimating")&&e.removeDataset(this._menuNode,"uiAnimating")}))}toggle(){e.isConnected(this._menuNode)?this.hide():this.show()}update(){this._popper&&this._popper.update()}}i.defaults={placeholder:"",lang:{clear:"Remove selection",error:"Error loading data.",loading:"Loading..",maxSelections:"Selection limit reached.",search:"Search"},data:null,getResults:null,renderResult:t=>t,renderSelection:t=>t,sanitize:t=>e.sanitize(t),isMatch(t,s){const i=e._escapeRegExp(s),n=new RegExp(i,"i");if(n.test(t))return!0;const a=t.normalize("NFD").replace(/[\u0300-\u036f]/g,"");return n.test(a)},sortResults(t,e,s){const i=t.toLowerCase(),n=e.toLowerCase();if(s){const t=i.indexOf(s)-n.indexOf(s);if(t)return t}return i.localeCompare(n)},validTag:t=>!!t,maxSelections:0,minSearch:1,confirmKeys:[","," "],confirmOnBlur:!0,clearOnBlur:!0,showClear:!0,closeOnSelect:!0,debounce:250,duration:100,maxHeight:"250px",appendTo:null,fullWidth:!1,placement:"bottom",position:"start",fixed:!1,spacing:0,minContact:!1},i.classes={active:"active",disabled:"disabled",disabledItem:"disabled",focus:"focus",hide:"visually-hidden",info:"tagsinput-item text-body-secondary",item:"tagsinput-item",menu:"tagsinput-menu list-unstyled",menuSmall:"tagsinput-menu-sm",menuLarge:"tagsinput-menu-lg",placeholder:"tagsinput-placeholder",tagClear:"btn d-flex",tagClearIcon:"btn-close p-0 my-auto pe-none",tagGroup:"btn-group my-n1",tagInput:"tagsinput-input",tagItem:"btn",tagToggle:"tagsinput d-flex flex-wrap position-relative text-start"};const n=i.prototype;n.add=function(t){const e=this._value.concat([t]);this._setValue(e,{triggerEvent:!0})},n.getMaxSelections=function(){return this._maxSelections},n.getPlaceholder=function(){return this._placeholderText},n.getValue=function(){return this._value},n.remove=function(t){const e=this._value.filter((e=>e!=t));this._setValue(e,{triggerEvent:!0})},n.removeAll=function(){this._setValue([],{triggerEvent:!0})},n.setMaxSelections=function(t){this._maxSelections=t,this.hide(),this._refresh()},n.setPlaceholder=function(t){this._placeholderText=t,e.remove(this._placeholder),this._renderPlaceholder(),this._refresh()},n.setValue=function(t){this._setValue(t,{triggerEvent:!0})},n._events=function(){e.addEventDelegate(this._menuNode,"contextmenu.ui.tagsinput",'[data-ui-action="select"]',(t=>{t.preventDefault()})),e.addEvent(this._menuNode,"mousedown.ui.tagsinput",(t=>{e.isSame(this._searchInput,t.target)||t.preventDefault()})),e.addEvent(this._menuNode,"click.ui.tagsinput",(t=>{t.stopPropagation()})),e.addEvent(this._node,"focus.ui.tagsinput",(t=>{e.isSame(this._node,document.activeElement)&&e.focus(this._searchInput)})),e.addEventDelegate(this._menuNode,"click.ui.tagsinput",'[data-ui-action="select"]',(t=>{t.preventDefault(),e.setDataset(this._searchInput,{uiKeepFocus:!0});const s=e.getDataset(t.currentTarget,"uiValue");this._selectValue(s),e.removeDataset(this._searchInput,"uiKeepFocus")})),e.addEventDelegate(this._menuNode,"mouseover.ui.tagsinput",'[data-ui-action="select"]',e.debounce((t=>{const s=e.findOne("[data-ui-focus]",this._menuNode);e.removeClass(s,this.constructor.classes.focus),e.removeDataset(s,"uiFocus"),e.addClass(t.currentTarget,this.constructor.classes.focus),e.setDataset(t.currentTarget,{uiFocus:!0});const i=e.getAttribute(t.currentTarget,"id");e.setAttribute(this._toggle,{"aria-activedescendent":i}),e.setAttribute(this._searchInput,{"aria-activedescendent":i})}))),e.addEvent(this._searchInput,"input.ui.tagsinput",e.debounce((t=>{if(this._updateSearchWidth(),this._getData)if(e.isConnected(this._menuNode)){const t=e.getValue(this._searchInput);this._getData({term:t})}else this.show()}))),e.addEvent(this._searchInput,"keydown.ui.tagsinput",(t=>{if(this._options.confirmKeys.includes(t.key)){t.preventDefault(),e.setDataset(this._searchInput,{uiKeepFocus:!0});const s=e.getValue(this._searchInput);return this._selectValue(s),void e.removeDataset(this._searchInput,"uiKeepFocus")}if("Backspace"===t.code)return void(this._value.length&&!e.getValue(this._searchInput)&&(t.preventDefault(),this._value.pop(),e.setDataset(this._searchInput,{uiKeepFocus:!0}),this._refresh(),e.setValue(this._searchInput,""),e.focus(this._searchInput),this._updateSearchWidth(),e.triggerEvent(this._searchInput,"input.ui.tagsinput"),e.removeDataset(this._searchInput,"uiKeepFocus")));if("Escape"===t.code&&e.isConnected(this._menuNode))return t.stopPropagation(),this.hide(),void e.triggerEvent(this._searchInput,"focus.ui.tagsinput");if(!["ArrowDown","ArrowUp","Enter","NumpadEnter"].includes(t.code))return;if(!e.isConnected(this._menuNode))return void this.show();const s=e.findOne("[data-ui-focus]",this._menuNode);switch(t.code){case"Enter":case"NumpadEnter":let t;return s?(t=e.getDataset(s,"uiValue"),e.setValue(this._searchInput,"")):t=e.getValue(this._searchInput),e.setDataset(this._searchInput,{uiKeepFocus:!0}),this._selectValue(t),void e.removeDataset(this._searchInput,"uiKeepFocus")}let i;if(s){let e=this._activeItems.indexOf(s);switch(t.code){case"ArrowDown":e++;break;case"ArrowUp":e--}i=this._activeItems[e]}else i=this._activeItems[0];if(!i)return;e.removeClass(s,this.constructor.classes.focus),e.removeDataset(s,"uiFocus"),e.addClass(i,this.constructor.classes.focus),e.setDataset(i,{uiFocus:!0});const n=e.getAttribute(i,"id");e.setAttribute(this._toggle,{"aria-activedescendent":n}),e.setAttribute(this._searchInput,{"aria-activedescendent":n});const a=e.getScrollY(this._menuNode),o=e.rect(this._menuNode,{offset:!0}),h=e.rect(i,{offset:!0});h.top<o.top?e.setScrollY(this._menuNode,a+h.top-o.top):h.bottom>o.bottom&&e.setScrollY(this._menuNode,a+h.bottom-o.bottom)})),this._options.getResults&&e.addEvent(this._menuNode,"scroll.ui.tagsinput",e._throttle((t=>{if(this._request||!this._showMore)return;const s=e.height(this._menuNode),i=e.height(this._menuNode,{boxSize:e.SCROLL_BOX});if(e.getScrollY(this._menuNode)>=i-s-s/4){const t=e.getValue(this._searchInput),s=this._data.length;this._loadingScroll=!0,this._getData({term:t,offset:s})}}),250,{leading:!1})),e.addEvent(this._searchInput,"focus.ui.tagsinput",(t=>{e.isSame(this._searchInput,document.activeElement)&&(e.hide(this._placeholder),e.detach(this._placeholder),e.addClass(this._toggle,"focus"))})),e.addEvent(this._searchInput,"blur.ui.tagsinput",(t=>{if(e.isSame(this._searchInput,document.activeElement))return;if(e.getDataset(this._searchInput,"uiKeepFocus"))return;const s=e.getValue(this._searchInput);s&&(this._options.confirmOnBlur?this._selectValue(s,{focus:!1}):this._options.clearOnBlur&&e.setValue(this._searchInput,"")),e.removeClass(this._toggle,"focus"),e.isConnected(this._menuNode)?"out"!==e.getDataset(this._menuNode,"uiAnimating")&&(e.stop(this._menuNode),e.removeDataset(this._menuNode,"uiAnimating"),this.hide()):this._refreshPlaceholder()})),e.addEvent(this._toggle,"mousedown.ui.tagsinput",(t=>{e.is(t.target,'[data-ui-action="clear"]')?t.preventDefault():(e.hasClass(this._toggle,"focus")?e.setDataset(this._searchInput,{uiKeepFocus:!0}):(e.hide(this._placeholder),e.addClass(this._toggle,"focus")),e.addEventOnce(window,"mouseup.ui.tagsinput",(s=>{e.removeDataset(this._searchInput,"uiKeepFocus"),e.focus(this._searchInput),t.button||this.show()})))})),e.addEventDelegate(this._toggle,"click.ui.tagsinput",'[data-ui-action="clear"]',(t=>{if(t.button)return;t.stopPropagation();const s=e.parent(t.currentTarget),i=e.index(s),n=this._value.slice();n.splice(i,1),this._setValue(n,{triggerEvent:!0}),e.focus(this._searchInput)}))},n._buildOption=function(t){return t in this._optionLookup||(this._optionLookup[t]=e.create("option",{text:t,value:t,properties:{selected:!0}})),this._optionLookup[t]},n._getDataFromDOM=function(t){return e.children(t).map((t=>e.getValue(t)))},n._getDataInit=function(){this._getData=({term:t=null})=>{if(this._activeItems=[],e.empty(this._menuNode),e.setAttribute(this._toggle,{"aria-activedescendent":""}),e.setAttribute(this._searchInput,{"aria-activedescendent":""}),this._options.minSearch&&(!t||t.length<this._options.minSearch))return e.hide(this._menuNode),void this.update();if(e.show(this._menuNode),this._maxSelections&&this._value.length>=this._maxSelections){const t=this._renderInfo(this._options.lang.maxSelections);return e.append(this._menuNode,t),void this.update()}let s=this._data;if(t){const e=this._options.isMatch.bind(this),i=this._options.sortResults.bind(this);s=this._data.filter((s=>e(s,t))).sort(((e,s)=>i(e,s,t)))}this._renderResults(s),this.update()}},n._getResultsInit=function(){const t=e._debounce((({offset:t,term:s})=>{const i={offset:t};s&&(i.term=s);const n=Promise.resolve(this._options.getResults(i));n.then((s=>{if(this._request!==n)return;const i=s.results;t?(this._data.push(...i),e.detach(this._loader)):(this._data=i,e.empty(this._menuNode)),this._showMore=s.showMore,this._renderResults(i),this._request=null})).catch((t=>{this._request===n&&(e.detach(this._loader),e.append(this._menuNode,this._error),this._request=null)})).finally((t=>{this._loadingScroll=!1,this.update()})),this._request=n}),this._options.debounce);this._getData=({offset:s=0,term:i=null})=>{if(this._request&&this._request.cancel&&this._request.cancel(),this._request=null,s)e.detach(this._error);else{this._activeItems=[],e.setAttribute(this._toggle,{"aria-activedescendent":""}),e.setAttribute(this._searchInput,{"aria-activedescendent":""});const t=e.children(this._menuNode,(t=>!e.isSame(t,this._loader)));e.detach(t)}if(this._options.minSearch&&(!i||i.length<this._options.minSearch))return e.hide(this._menuNode),void this.update();if(e.show(this._menuNode),this._maxSelections&&this._value.length>=this._maxSelections){const t=this._renderInfo(this._options.lang.maxSelections);return e.append(this._menuNode,t),void this.update()}const n=e.child(this._menuNode,":last-child");n&&e.isSame(n,this._loader)||e.append(this._menuNode,this._loader),this.update(),t({offset:s,term:i})}},n._refresh=function(){this._value||(this._value=[]),this._maxSelections&&this._value.length>this._maxSelections&&(this._value=this._value.slice(0,this._maxSelections)),this._value=e._unique(this._value),e.detach(this._searchInput),e.empty(this._node),e.empty(this._toggle),this._refreshDisabled(),this._refreshPlaceholder();for(const t of this._value){const s=this._buildOption(t);e.append(this._node,s);const i=this._renderSelection(t);e.append(this._toggle,i)}e.append(this._toggle,this._searchInput)},n._refreshDisabled=function(){const t=e.is(this._node,":disabled");t?(e.addClass(this._toggle,this.constructor.classes.disabled),e.setAttribute(this._searchInput,{tabindex:-1})):(e.removeClass(this._toggle,this.constructor.classes.disabled),e.removeAttribute(this._searchInput,"tabindex")),e.setAttribute(this._toggle,{"aria-disabled":t})},n._refreshPlaceholder=function(){this._value.length?e.hide(this._placeholder):(e.show(this._placeholder),e.prepend(this._toggle,this._placeholder))},n._render=function(){this._renderPlaceholder(),this._renderMenu(),this._renderToggle(),this._options.getResults&&(this._loader=this._renderInfo(this._options.lang.loading),this._error=this._renderInfo(this._options.lang.error)),this._popperOptions={reference:this._toggle,placement:this._options.placement,position:this._options.position,fixed:this._options.fixed,spacing:this._options.spacing,minContact:this._options.minContact},this._options.fullWidth&&(this._popperOptions.afterUpdate=(t,s)=>{const i=e.width(s,e.BORDER_BOX);e.setStyle(t,{width:`${i}px`})},this._popperOptions.beforeUpdate=t=>{e.setStyle(t,{width:""})}),e.addClass(this._node,this.constructor.classes.hide),e.setAttribute(this._node,{tabindex:-1}),e.after(this._node,this._toggle)},n._renderInfo=function(t){return e.create("li",{html:this._options.sanitize(t),class:this.constructor.classes.info})},n._renderItem=function(t){const i=s.generateId("autocomplete-item"),n=this._value.some((e=>e==t)),a=e.create("li",{class:this.constructor.classes.item,attributes:{id:i,role:"option","aria-label":t,"aria-selected":n},dataset:{uiAction:"select",uiValue:t}});this._activeItems.push(a),n&&(e.addClass(a,this.constructor.classes.active),e.setDataset(a,{uiActive:!0}));const o=this._options.renderResult.bind(this)(t,a);return e._isString(o)?e.setHTML(a,this._options.sanitize(o)):e._isElement(o)&&!e.isSame(a,o)&&e.append(a,o),a},n._renderMenu=function(){const t=s.generateId("selectmenu");this._menuNode=e.create("ul",{class:this.constructor.classes.menu,style:{maxHeight:this._options.maxHeight},attributes:{id:t,role:"listbox","aria-multiselectable":!0}}),e.is(this._node,".input-sm")?e.addClass(this._menuNode,this.constructor.classes.menuSmall):e.is(this._node,".input-lg")&&e.addClass(this._menuNode,this.constructor.classes.menuLarge)},n._renderPlaceholder=function(){this._placeholder=e.create("span",{html:this._placeholderText?this._options.sanitize(this._placeholderText):"&nbsp;",class:this.constructor.classes.placeholder})},n._renderResults=function(t){e.show(this._menuNode);for(const s of t){const t=this._renderItem(s);e.append(this._menuNode,t)}if(e.hasChildren(this._menuNode)){if(!e.findOne("[data-ui-focus]",this._menuNode)&&this._activeItems.length){const t=this._activeItems[0];e.addClass(t,this.constructor.classes.focus),e.setDataset(t,{uiFocus:!0});const s=e.getAttribute(t,"id");e.setAttribute(this._toggle,{"aria-activedescendent":s}),e.setAttribute(this._searchInput,{"aria-activedescendent":s})}}else e.hide(this._menuNode)},n._renderSelection=function(t){const s=e.create("div",{class:this.constructor.classes.tagGroup}),i=e.create("div",{class:this.constructor.classes.tagItem}),n=this._options.renderSelection.bind(this)(t,i);if(e._isString(n)?e.setHTML(i,this._options.sanitize(n)):e._isElement(n)&&!e.isSame(i,n)&&e.append(i,n),this._options.showClear){const t=e.create("div",{class:this.constructor.classes.tagClear,attributes:{role:"button","aria-label":this._options.lang.clear},dataset:{uiAction:"clear"}});e.append(s,t);const i=e.create("small",{class:this.constructor.classes.tagClearIcon});e.append(t,i)}return e.append(s,i),s},n._renderToggle=function(){const t=e.getAttribute(this._menuNode,"id");this._toggle=e.create("div",{class:[e.getAttribute(this._node,"class")||"",this.constructor.classes.tagToggle],attributes:{role:"combobox","aria-haspopup":"listbox","aria-expanded":!1,"aria-disabled":!1,"aria-controls":t,"aria-activedescendent":""}}),this._searchInput=e.create("input",{class:this.constructor.classes.tagInput,attributes:{role:"searchbox","aria-autocomplete":"list","aria-label":this._options.lang.search,"aria-describedby":t,"aria-activedescendent":"",autocomplete:"off"}})},n._selectValue=function(t,{focus:s=!0}={}){if(this._options.trimValue&&(t=t.trim()),!this._value.some((e=>e==t))){const e=this._value.concat([t]);this._setValue(e,{triggerEvent:!0}),this._refreshPlaceholder()}e.setValue(this._searchInput,""),this._options.closeOnSelect?this.hide():this._getData&&this._getData({}),s&&e.focus(this._searchInput)},n._setValue=function(t,{triggerEvent:s=!1}={}){t=t.filter(this._options.validTag),(!this._value||t.length!==this._value.length||t.some(((t,e)=>t!==this._value[e])))&&(this._value=t,this._refresh(),s&&e.triggerEvent(this._node,"change.ui.tagsinput"))},n._updateSearchWidth=function(){const t=e.create("span",{text:e.getValue(this._searchInput),style:{display:"inline-block",fontSize:e.css(this._searchInput,"fontSize"),whiteSpace:"pre-wrap"}});e.append(document.body,t);const s=e.width(t);e.setStyle(this._searchInput,{width:s+2}),e.remove(t)},s.initComponent("tagsinput",i),t.TagsInput=i}));